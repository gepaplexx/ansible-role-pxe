---
- name: Ensure tftp directory for pxe exists
  file:
    path: "{{ tftp_root_directory }}"
    state: directory
    owner: "{{ tftp_user }}"
    group: "{{ tftp_group }}"
    mode: "{{ tftp_mode }}"
  tags:
    - tftp

- name: Ensure pxelinux.cfg directory exists
  file:
    path: "{{ tftp_root_directory }}/pxelinux.cfg"
    state: directory
    owner: "{{ tftp_user }}"
    group: "{{ tftp_group }}"
    mode: "{{ tftp_mode }}"
  tags:
    - tftp

- name: Download RHEL
  get_url:
    url: "{{ rhel_download_url }}"
    dest: /tmp/rhel.iso
    mode: '0644'
    checksum: "{{ rhel_download_checksum }}"
  tags:
    - tftp

- name: Extract files for pxe boot
  iso_extract:
    image: /tmp/rhel.iso
    dest: /tmp
    files:
      - BaseOS/Packages/syslinux-tftpboot-6.04-4.el8.noarch.rpm
      # - BaseOS/Packages/shim-ia32-15-16.el8.x86_64.rpm
      - BaseOS/Packages/shim-x64-15-16.el8.x86_64.rpm
      # - BaseOS/Packages/grub2-efi-ia32-2.02-90.el8.x86_64.rpm
      - BaseOS/Packages/grub2-efi-x64-2.02-90.el8.x86_64.rpm
      - isolinux/ldlinux.c32
      - isolinux/libutil.c32
      - EFI/BOOT/grub.cfg

- name: extract rpm files
  shell: "set -o pipefail && rpm2cpio {{ item }} | cpio -dimv"
  args:
    chdir: /tmp
    executable: /bin/bash
  changed_when: false
  with_items:
    - syslinux-tftpboot-6.04-4.el8.noarch.rpm
    # - shim-ia32-15-16.el8.x86_64.rpm
    - shim-x64-15-16.el8.x86_64.rpm
    # - grub2-efi-ia32-2.02-90.el8.x86_64.rpm
    - grub2-efi-x64-2.02-90.el8.x86_64.rpm

- name: Copy files to tftp root dir
  copy:
    src: "/tmp/{{ item }}"
    dest: "{{ tftp_root_directory }}"
    owner: "{{ tftp_user }}"
    group: "{{ tftp_group }}"
    mode: '644'
    remote_src: true
  with_items:
    - tftpboot/pxelinux.0
    - tftpboot/menu.c32
    - tftpboot/libmenu.c32
    - boot/efi/EFI/BOOT/BOOTX64.EFI
    - boot/efi/EFI/redhat/grubx64.efi
    - ldlinux.c32
    - libutil.c32
    - grub.cfg
  tags:
    - tftp

- name: Ensure service is started
  service:
    name: "{{ tftp_service }}"
    state: started
    enabled: true
  tags:
    - tftp

- name: Generate grub.cfg for master
  template:
    src: "grub.cfg.j2"
    dest: "{{ tftp_root_directory }}/grub.cfg-01-{{ item | replace(':', '-') }}"
    owner: root
    group: "root"
    mode: 0644
  with_items:
    - "{{ master }}"
  vars:
    fallback: master
  tags:
    - tftp

- name: Generate grub.cfg for worker
  template:
    src: "grub.cfg.j2"
    dest: "{{ tftp_root_directory }}/grub.cfg-01-{{ item | replace(':', '-') }}"
    owner: root
    group: "root"
    mode: 0644
  with_items:
    - "{{ worker }}"
  vars:
    fallback: worker
  tags:
    - tftp

- name: Generate grub.cfg for bootstrap
  template:
    src: "grub.cfg.j2"
    dest: "{{ tftp_root_directory }}/grub.cfg-01-{{ item | replace(':', '-') }}"
    owner: root
    group: "root"
    mode: 0644
  with_items:
    - "{{ bootstrap }}"
  vars:
    fallback: bootstrap
  tags:
    - tftp

- name: Generate pxelinux.cfg for bootstrap
  template:
    src: "pxelinux.cfg.j2"
    dest: "{{ tftp_root_directory }}/pxelinux.cfg/01-{{ item | replace(':', '-') }}"
    owner: root
    group: "root"
    mode: 0644
  with_items:
    - "{{ bootstrap }}"
  vars:
    default: bootstrap
  tags:
    - tftp

- name: Generate pxelinux.cfg for master
  template:
    src: "pxelinux.cfg.j2"
    dest: "{{ tftp_root_directory }}/pxelinux.cfg/01-{{ item | replace(':', '-') }}"
    owner: root
    group: "root"
    mode: 0644
  with_items:
    - "{{ master }}"
  vars:
    default: master
  tags:
    - tftp

- name: Generate pxelinux.cfg for worker
  template:
    src: "pxelinux.cfg.j2"
    dest: "{{ tftp_root_directory }}/pxelinux.cfg/01-{{ item | replace(':', '-') }}"
    owner: root
    group: "root"
    mode: 0644
  with_items:
    - "{{ worker }}"
  vars:
    default: worker
  tags:
    - tftp

- name: Generate default pxelinux.cfg
  template:
    src: "pxelinux.cfg.j2"
    dest: "{{ tftp_root_directory }}/pxelinux.cfg/default"
    owner: root
    group: "root"
    mode: 0644
  vars:
    default: default
  tags:
    - tftp

- name: Download Kernel
  get_url:
    url: "{{ openshift_mirror_url }}/{{ linuxefi }}"
    dest: "{{ tftp_root_directory }}"
    mode: '0644'
  tags:
    - tftp

- name: Download Initramfs
  get_url:
    url: "{{ openshift_mirror_url }}/{{ initrdefi }}"
    dest: "{{ tftp_root_directory }}"
    mode: '0644'
  tags:
    - tftp

...
